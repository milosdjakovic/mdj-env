# ============================================
# CORE SETTINGS
# ============================================
set -g base-index 1
setw -g pane-base-index 1
set -g mouse on
set -g renumber-windows on
setw -g mode-keys vi

set -g @yank_action "copy-pipe"

# Prefix: Ctrl + `
unbind C-b
set-option -g prefix 'M-z'
bind 'M-z' send-prefix

set -g status-right ""

# ============================================
# PREFIX BINDINGS
# ============================================

# # FZF session switcher
# bind s display-popup -w 80 -h 70% -E "tmux list-sessions -F '#{session_name}' | fzf --reverse | xargs tmux switch-client -t"

# # Traditional choose-tree for sessions (visual, hierarchical)
# bind S choose-tree -s

# # Windows (across all sessions)
# bind w display-popup -w 80 -h 70% -E "tmux list-windows -a -F '#{session_name}:#{window_index} - #{window_name}' | fzf --reverse | cut -d' ' -f1 | xargs tmux switch-client -t"

# # Traditional choose-tree for windows
# bind W choose-tree -w

# # Panes (across all sessions)
# bind f display-popup -w 80 -h 70% -E "tmux list-panes -a -F '#{session_name}:#{window_index}.#{pane_index} - #{window_name}: #{pane_current_command}' | fzf --reverse | cut -d' ' -f1 | xargs tmux switch-client -t"

# # General choose-tree (shows everything: sessions, windows, panes)
# bind F choose-tree

# FZF session switcher with last attached session highlighted
bind s display-popup -w 80 -h 70% -E "\
  tmux list-sessions -F '#{session_last_attached} #{session_name}' | \
  sort -r | \
  cut -d' ' -f2- | \
  grep -v \"^$(tmux display-message -p '#S')\$\" | \
  fzf --reverse \
      --header=\"Sessions | Current: $(tmux display-message -p '#S')\" \
      --header-first | \
  xargs tmux switch-client -t"

# Traditional choose-tree for sessions (visual, hierarchical)
bind S choose-tree -Zs

# FZF windows switcher (sorted by last used, current excluded)
bind w display-popup -w 80 -h 70% -E "\
  tmux list-windows -a -F '#{window_activity} #{session_name}:#{window_index} - #{window_name}' | \
  sort -r | \
  cut -d' ' -f2- | \
  grep -v \"^$(tmux display-message -p '#S:#I')\s\" | \
  fzf --reverse \
      --header=\"Windows | Current: $(tmux display-message -p '#S:#I - #W')\" \
      --header-first | \
  cut -d' ' -f1 | \
  xargs tmux switch-client -t"

# Traditional choose-tree for windows
bind W choose-tree -Zw

# FZF panes switcher (sorted by last used, current excluded)
bind f display-popup -w 80 -h 70% -E "\
  tmux list-panes -a -F '#{pane_last_used} #{session_name}:#{window_index}.#{pane_index} - #{window_name}: #{pane_current_command}' | \
  sort -r | \
  cut -d' ' -f2- | \
  grep -v \"^$(tmux display-message -p '#S:#I.#P')\s\" | \
  fzf --reverse \
      --header=\"Panes | Current: $(tmux display-message -p '#S:#I.#P - #W')\" \
      --header-first | \
  cut -d' ' -f1 | \
  xargs tmux switch-client -t"

# General choose-tree (shows everything: sessions, windows, panes)
bind F choose-tree -Z

# Session switching
bind e switch-client -l    # last session
bind ( switch-client -p    # previous session
bind ) switch-client -n    # next session

# Windows
bind a last-window
bind p previous-window
bind n next-window
bind P swap-window -t -1\; select-window -t -1
bind N swap-window -t +1\; select-window -t +1

# Panes - navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
bind o select-pane -t :.+
bind O select-pane -t :.-

# Panes - resizing
bind -r H resize-pane -L 2
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2
bind -r L resize-pane -R 2

# Panes - zoom
bind z resize-pane -Z

# Lazygit floating pane
bind g display-popup -d "#{pane_current_path}" -w 90% -h 90% -E "lazygit"

# Splits & new windows
bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# ============================================
# PLUGINS
# ============================================
set -g @continuum-restore 'on'
set -g @resurrect-hook-pre-restore-pane-processes 'tmux switch-client -n && tmux kill-session -t=0'

TMUX_FZF_LAUNCH_KEY="m"

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'sainnhe/tmux-fzf'

run-shell "$(brew --prefix tpm)/share/tpm/tpm"


# ============================================
# STATUS BAR
# ============================================

# # Reset to defaults first
# set -gu status-left
# set -gu status-left-length
# set -gu status-right
# set -gu window-status-current-style
# set -gu window-status-current-format
# set -gu window-status-last-style
# set -gu window-status-format
# set -gu window-status-style

# ============================================

# Transparent by default, green when prefix active
set -g status-style '#{?client_prefix,bg=green fg=black,bg=default fg=default}'

# Session name on left
set -g status-left '[#S] '
set -g status-left-length 20

# Keyboard emoji when prefix pressed
set -g status-right '#{?client_prefix, âŒ¨ï¸ ,}'

# Current window - with zoom indicator
set -g window-status-current-style 'fg=green'
set -g window-status-current-format "#{?client_prefix,#[fg=black]>#I:#W#{?window_zoomed_flag, ğŸ”,}<,>#I:#W#{?window_zoomed_flag, ğŸ”,}<}"

# Last window - white normally, black when prefix pressed
set -g window-status-last-style '#{?client_prefix,fg=black,fg=white}'

# Other windows - underscore for last window + zoom indicator
set -g window-status-format "#{?#{m:*-*,#{window_flags}},-#I:#W#{?window_zoomed_flag, ğŸ”,},#I:#W#{?window_zoomed_flag, ğŸ”,}}"
set -g window-status-style 'fg=default'
